---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: gitlab
  namespace: spack
  labels:
    app: gitlab
    srv: web
spec:
  selector:
    matchLabels:
      app: gitlab
      srv: web
  replicas: 1
  serviceName: gitlab
  template:
    metadata:
      labels:
        app: gitlab
        srv: web
    spec:
      containers:
      - name: gitlab
        image: "gitlab/gitlab-ee:11.2.1-ee.0"
        imagePullPolicy: IfNotPresent
        env:
        - name: GITLAB_OMNIBUS_CONFIG
          value: |
            external_url 'http://gitlab'

            root_pass = ENV['GITLAB_ROOT_PASSWORD'];
            gitlab_rails['initial_root_password'] = (
                root_pass unless root_pass.to_s == '');

            gitlab_rails['gitlab_shell_ssh_port'] = 22;

            runner_token = ENV['GITLAB_RUNNER_TOKEN'];
            gitlab_rails['initial_shared_runners_registration_token'] = (
                runner_token unless runner_token.to_s == '');

            prometheus_monitoring['enable'] = false
            postgresql['enable'] = false;
            gitlab_rails['db_adapter'] = 'postgresql';
            gitlab_rails['db_encoding'] = 'utf8';
            gitlab_rails['db_host'] = ENV['DB_HOST'];
            gitlab_rails['db_password'] = ENV['DB_PASSWORD'];
            gitlab_rails['db_username'] = ENV['DB_USER'];
            gitlab_rails['db_database'] = ENV['DB_DATABASE'];

            require 'socket'
            gitlab_rails['auto_migrate'] = (
              Socket.gethostname.split('-')[-1] == '0')

            redis['enable'] = false;
            gitlab_rails['redis_host'] = ENV['REDIS_HOST'];
            gitlab_rails['redis_password'] = ENV['REDIS_PASSWORD'];

            # unicorn['worker_processes'] = 2;
            # manage_accounts['enable'] = true;
            # manage_storage_directories['manage_etc'] = false;

            # gitlab_shell['auth_file'] = (
            # '/gitlab-data/ssh/authorized_keys');
            # git_data_dir '/gitlab-data/git-data';
            # gitlab_rails['shared_path'] = '/gitlab-data/shared';
            # gitlab_rails['uploads_directory'] = (
            # '/gitlab-data/uploads');
            # gitlab_ci['builds_directory'] = '/gitlab-data/builds';
        - name: GITLAB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: gitlab-secrets
              key: gitlab-root-password
        - name: GITLAB_RUNNER_TOKEN
          valueFrom:
            secretKeyRef:
              name: gitlab-secrets
              key: gitlab-runner-token
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: gitlab-secrets
              key: gitlab-db-host
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: gitlab-secrets
              key: gitlab-db-user
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef: {'name': 'gitlab-secrets', 'key': 'gitlab-db-password'}
        - name: DB_DATABASE
          valueFrom:
            secretKeyRef: {'name': 'gitlab-secrets', 'key': 'gitlab-db-name'}
        - name: REDIS_HOST
          valueFrom:
            secretKeyRef:
              name: gitlab-secrets
              key: gitlab-cache-host
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: gitlab-secrets
              key: gitlab-cache-password
        ports:
        - name: http
          containerPort: 80
        livenessProbe:
          httpGet:
            path: /help
            port: 80
          initialDelaySeconds: 180
          timeoutSeconds: 1
          periodSeconds: 10
          successThreshold: 1
          failureThreshold: 10
        readinessProbe:
          httpGet:
            path: /help
            port: 80
          initialDelaySeconds: 30
          timeoutSeconds: 1
          periodSeconds: 10
          successThreshold: 1
          failureThreshold: 3
        volumeMounts:
        - name: gitlab-vol-etc
          mountPath: /etc/gitlab
        - name: gitlab-vol-data
          mountPath: /gitlab-data
        resources:
          requests:
            memory: 1Gi
            cpu: 500m
          limits:
            memory: 2Gi
            cpu: 1
  volumeClaimTemplates:
  - metadata:
      name: gitlab-vol-data
    spec:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 10Gi
  - metadata:
      name: gitlab-vol-etc
    spec:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 1Gi
